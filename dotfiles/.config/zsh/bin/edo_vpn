#!/usr/bin/expect -f

set argv1 [lindex $argv 0]
set argv2 [lindex $argv 1]
set argv3 [lindex $argv 2]

if { $argv1 eq "--config" } {
    set service $argv2
    set port $argv3
} elseif { $argv1 eq "--env" } {
    if { $argv2 eq "local" } {
        set service "127.0.0.1"
    }
} else {
    set service "127.0.0.1"
}

if { [info exists port] == 0 || $port eq "" } {
    set port 1080
}

set otp [exec python3 -c "import pyotp; print(pyotp.TOTP('QNHTHLGFZHRJKQ6N').now())" ]
set username "jdeng"
set mypassword "vABkav6JNNpZn6qdcL3jdLXGy1pempWb"

set configfile /Users/jiarong/Documents/work/others/edison_local.ovpn
#set timeout 10

spawn openvpn --config $configfile --socks-proxy $service $port
expect {
"*Enter Auth Username:" { send "$username\r"; exp_continue}
"*Enter Auth Password:" { send "$mypassword\r"; exp_continue }
"*Enter Authenticator Code" { send "$otp\r" }
}
interact
