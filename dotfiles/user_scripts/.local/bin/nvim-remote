#!/usr/bin/env bash
#
# nvim-remote - Connect to remote Neovim instance in DevPod workspace
#
# Description:
#   Enables running and connecting to a remote Neovim instance inside a DevPod
#   workspace with SSH port forwarding. Automatically manages port allocation,
#   server lifecycle, and cleanup on exit.
#
# Usage:
#   nvim-remote
#
#   The script will:
#   1. Present a list of available DevPod instances via fzf
#   2. Reuse existing port or find a new available port
#   3. Deploy and launch headless Neovim server on remote instance
#   4. Create SSH tunnel with port forwarding
#   5. Connect local Neovim client to remote server
#   6. Clean up resources on exit
#
# Requirements:
#   - fzf (fuzzy finder for instance selection)
#   - python3 (for finding available ports)
#   - SSH access to DevPod instances
#   - DevPod workspaces in ~/.devpod/contexts/default/workspaces
#
# Environment:
#   DEVPOD_WORKSPACES_DIR - Directory containing DevPod workspaces
#   SRV_PORT_FILE         - Remote file storing server port
#   LAUNCH_SCRIPT_FILE    - Temporary launch script path
#


DEVPOD_WORKSPACES_DIR="$HOME/.devpod/contexts/default/workspaces"
SRV_PORT_FILE="/tmp/nvim.srv"
LAUNCH_SCRIPT_FILE="/tmp/launch_nvim_server.sh"

# Select target instance
devpod_ins=($(ls $DEVPOD_WORKSPACES_DIR | sed 's/$/.devpod/' ))

ins=$({ printf '%s\n' "${devpod_ins[@]}"; } | fzf)

if [ -z "$ins" ]; then
  printf "Abort! No instance selected\n"
  exit 1
fi

# Choose available port
printf "ðŸ”„ Finding available port..."

local_port=$(ssh -T $ins "cat $SRV_PORT_FILE 2>/dev/null")

if [ -z "$local_port" ]; then
  local_port=$(python3 - <<EOF
import socket
s = socket.socket()
s.bind(('', 0))
print(s.getsockname()[1])
s.close()
EOF
)

  if [ -z "$local_port" ]; then
    printf "Abort! Invalid port\n"
    exit 1
  fi
fi

printf "\r\033[KðŸŽ² Found available port $local_port\n"

# Prepare launch script
cat <<EOF > "$LAUNCH_SCRIPT_FILE"
port="\$1"

if [ -z "\$port" ]; then
  printf "Abort! Invalid port\n"
  exit 1
fi

echo "\$port" > $SRV_PORT_FILE

nvim --headless --listen 0.0.0.0:\$port
EOF

printf "ðŸ”„ Sending launch script to ${ins}..."

scp "$LAUNCH_SCRIPT_FILE" "$ins:$LAUNCH_SCRIPT_FILE" >/dev/null

printf "\r\033[Kâœ¨ Launch script sent\n"

# Launch the remote neovim server
printf "ðŸ”„ Running neovim server at %s:%s..." "$ins" "$local_port"

ssh -T -L "$local_port:localhost:$local_port" $ins "bash -l $LAUNCH_SCRIPT_FILE $local_port" &

printf "\r\033[KðŸ”¥ Remote neovim server is running on %s:%s\n" "$ins" "$local_port"

# Set the trap for EXIT to apply the cleanup operations
remote_nvim_running=1
function _cleanup() {
  remote_nvim_running=0

  printf "\r\033[KðŸ”„ Stopping remote neovim server..."
  ssh -T $ins "bash -lc 'rm $SRV_PORT_FILE; nvim --server 0.0.0.0:${local_port} --remote-send \"<Esc>:qa!<CR>\" >/dev/null 2>&1'"
  printf "\r\033[KðŸ‘‹ Remote neovim server stopped\n"

  exit 1
}

trap _cleanup EXIT

# Try to attach to the remote neovim
while true; do
  if [ "$remote_nvim_running" -eq 0 ]; then
    exit 1
  fi

  sleep 1

  nvim --remote-ui --server 0.0.0.0:$local_port 2>/dev/null && break

  printf "\r\033[KðŸ”„ Waiting for the remote neovim to come up..."
done
